<!DOCTYPE html>
<html>
<head>
    <title>Azure Static Web Apps Auth Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Azure Static Web Apps Authentication Debug</h1>
    <div id="results"></div>
    
    <script>
        async function debugAuth() {
            const results = document.getElementById('results');
            
            // Check /.auth/me endpoint
            try {
                const response = await fetch('/.auth/me');
                const contentType = response.headers.get('content-type');
                
                results.innerHTML += `<h2>/.auth/me Endpoint Check</h2>`;
                results.innerHTML += `<p><strong>Status:</strong> ${response.status} ${response.statusText}</p>`;
                results.innerHTML += `<p><strong>Content-Type:</strong> ${contentType}</p>`;
                
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    results.innerHTML += `<p class="success">✓ JSON response received</p>`;
                    results.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    
                    if (data.clientPrincipal) {
                        results.innerHTML += `<p class="success">✓ User is authenticated</p>`;
                        results.innerHTML += `<p><strong>Identity Provider:</strong> ${data.clientPrincipal.identityProvider}</p>`;
                        results.innerHTML += `<p><strong>User Details:</strong> ${data.clientPrincipal.userDetails}</p>`;
                    } else {
                        results.innerHTML += `<p class="warning">⚠ User is not authenticated</p>`;
                        results.innerHTML += `<p><a href="/.auth/login/aad">Click here to login</a></p>`;
                    }
                } else {
                    results.innerHTML += `<p class="error">✗ HTML response received (authentication not configured)</p>`;
                    const text = await response.text();
                    results.innerHTML += `<h3>Response Preview:</h3>`;
                    results.innerHTML += `<pre>${text.substring(0, 500)}...</pre>`;
                    
                    results.innerHTML += `<h3 class="error">Configuration Issues Detected:</h3>`;
                    results.innerHTML += `<ul class="error">`;
                    results.innerHTML += `<li>Azure Static Web Apps authentication is not properly configured</li>`;
                    results.innerHTML += `<li>Missing AZURE_CLIENT_ID environment variable</li>`;
                    results.innerHTML += `<li>Missing AZURE_CLIENT_SECRET environment variable</li>`;
                    results.innerHTML += `<li>staticwebapp.config.json may not be deployed correctly</li>`;
                    results.innerHTML += `</ul>`;
                }
            } catch (error) {
                results.innerHTML += `<p class="error">✗ Error checking auth endpoint: ${error.message}</p>`;
            }
            
            // Check current URL and environment
            results.innerHTML += `<h2>Environment Information</h2>`;
            results.innerHTML += `<p><strong>Current URL:</strong> ${window.location.href}</p>`;
            results.innerHTML += `<p><strong>Host:</strong> ${window.location.host}</p>`;
            results.innerHTML += `<p><strong>Protocol:</strong> ${window.location.protocol}</p>`;
            
            // Check for Azure Static Web Apps specific headers/context
            try {
                const response = await fetch(window.location.href, { method: 'HEAD' });
                const serverHeader = response.headers.get('server');
                results.innerHTML += `<p><strong>Server:</strong> ${serverHeader || 'Not available'}</p>`;
                
                if (serverHeader && serverHeader.includes('StaticWebApps')) {
                    results.innerHTML += `<p class="success">✓ Running on Azure Static Web Apps</p>`;
                } else {
                    results.innerHTML += `<p class="warning">⚠ May not be running on Azure Static Web Apps</p>`;
                }
            } catch (e) {
                results.innerHTML += `<p>Server header check failed: ${e.message}</p>`;
            }
        }
        
        debugAuth();
    </script>
</body>
</html>
